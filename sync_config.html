<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络同步配置 - 项目管理系统</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        error: '#ef4444',
                        info: '#3b82f6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-all {
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center">
                        <i class="fa fa-cubes text-primary text-2xl mr-3"></i>
                        <span class="text-xl font-bold text-gray-800">项目管理系统</span>
                    </a>
                    <nav class="hidden md:ml-8 md:flex space-x-8">
                        <a href="index.html" class="text-gray-600 hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-all">
                            <i class="fa fa-dashboard mr-1"></i>首页统计
                        </a>
                        <a href="projects.html" class="text-gray-600 hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-all">
                            <i class="fa fa-folder-open mr-1"></i>项目数据库
                        </a>
                        <a href="companies.html" class="text-gray-600 hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-all">
                            <i class="fa fa-building mr-1"></i>公司管理
                        </a>
                        <a href="sync_config.html" class="text-primary bg-blue-50 px-3 py-2 rounded-md text-sm font-medium transition-all">
                            <i class="fa fa-cloud mr-1"></i>网络同步
                        </a>
                    </nav>
                </div>
                <div class="flex items-center" id="syncStatusDiv">
                    <div class="mr-4">
                        <select id="syncProtocolSelect" class="text-sm border border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="websocket">WebSocket</option>
                            <option value="sse">SSE</option>
                        </select>
                    </div>
                    <!-- 同步状态将在这里显示 -->
                </div>
            </div>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-5 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">
                    <i class="fa fa-cog mr-2 text-primary"></i>网络同步配置
                </h2>
            </div>
            
            <div class="px-6 py-6">
                <!-- 同步状态概览 -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i class="fa fa-info-circle text-blue-500 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-blue-800">同步状态</h3>
                            <div class="mt-2 text-sm text-blue-700">
                                <div class="flex items-center mb-2">
                                    <span class="w-32">连接状态:</span>
                                    <span id="connectionStatus" class="font-medium">未连接</span>
                                </div>
                                <div class="flex items-center mb-2">
                                    <span class="w-32">上次同步:</span>
                                    <span id="lastSyncTime" class="font-medium">-</span>
                                </div>
                                <div class="flex items-center mb-2">
                                    <span class="w-32">待同步变更:</span>
                                    <span id="pendingChanges" class="font-medium">0</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="w-32">存储模式:</span>
                                    <span id="storageMode" class="font-medium">本地存储</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 配置表单 -->
                <form id="syncConfigForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- WebSocket服务器配置 -->
                        <div class="col-span-1 md:col-span-2">
                            <h3 class="text-md font-medium text-gray-900 mb-4">
                                <i class="fa fa-server mr-2 text-gray-600"></i>服务器配置
                            </h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="websocketUrl" class="block text-sm font-medium text-gray-700 mb-1">
                                            WebSocket服务器地址
                                        </label>
                                        <input type="url" id="websocketUrl" name="websocketUrl" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                               value="wss://socketsbay.com/wss/v2/1/demo/"
                                               placeholder="wss://your-server.com/ws">
                                        <p class="mt-1 text-xs text-gray-500">
                                            输入WebSocket服务器地址，用于实时数据同步。推荐使用：wss://socketsbay.com/wss/v2/1/demo/
                                        </p>
                                    </div>
                                    
                                    <div>
                                        <label for="sseServerUrl" class="block text-sm font-medium text-gray-700 mb-1">
                                            SSE服务器地址
                                        </label>
                                        <input type="url" id="sseServerUrl" name="sseServerUrl" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                               value="https://your-sse-server.com/events"
                                               placeholder="https://your-sse-server.com/events">
                                        <p class="mt-1 text-xs text-gray-500">
                                            输入SSE服务器地址，用于单向数据推送
                                        </p>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="syncInterval" class="block text-sm font-medium text-gray-700 mb-1">
                                        同步间隔 (秒)
                                    </label>
                                    <input type="number" id="syncInterval" name="syncInterval" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                           value="30" min="5" max="300">
                                    <p class="mt-1 text-xs text-gray-500">
                                        设置自动同步的时间间隔，建议30-60秒
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- 同步选项 -->
                        <div class="col-span-1 md:col-span-2">
                            <h3 class="text-md font-medium text-gray-900 mb-4">
                                <i class="fa fa-sliders mr-2 text-gray-600"></i>同步选项
                            </h3>
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="enableRealtimeSync" name="enableRealtimeSync" 
                                           class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                           checked>
                                    <label for="enableRealtimeSync" class="ml-2 block text-sm text-gray-700">
                                        启用实时同步
                                    </label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="enableOfflineMode" name="enableOfflineMode" 
                                           class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                           checked>
                                    <label for="enableOfflineMode" class="ml-2 block text-sm text-gray-700">
                                        启用离线模式
                                    </label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="autoSyncOnConnect" name="autoSyncOnConnect" 
                                           class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                           checked>
                                    <label for="autoSyncOnConnect" class="ml-2 block text-sm text-gray-700">
                                        连接时自动同步
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 存储管理 -->
                        <div class="col-span-1 md:col-span-2">
                            <h3 class="text-md font-medium text-gray-900 mb-4">
                                <i class="fa fa-database mr-2 text-gray-600"></i>存储管理
                            </h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <button type="button" id="exportDataBtn" 
                                            class="w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all">
                                        <i class="fa fa-download mr-2"></i>导出数据
                                    </button>
                                    
                                    <button type="button" id="importDataBtn" 
                                            class="w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all">
                                        <i class="fa fa-upload mr-2"></i>导入数据
                                    </button>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <button type="button" id="clearLocalDataBtn" 
                                            class="w-full inline-flex justify-center items-center px-4 py-2 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all">
                                        <i class="fa fa-trash mr-2"></i>清除本地数据
                                    </button>
                                    
                                    <button type="button" id="migrateDataBtn" 
                                            class="w-full inline-flex justify-center items-center px-4 py-2 border border-green-300 shadow-sm text-sm font-medium rounded-md text-green-700 bg-white hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all">
                                        <i class="fa fa-refresh mr-2"></i>迁移到IndexedDB
                                    </button>
                                </div>
                                
                                <input type="file" id="importFileInput" accept=".json" style="display: none;">
                            </div>
                        </div>

                        <!-- 同步日志 -->
                        <div class="col-span-1 md:col-span-2">
                            <h3 class="text-md font-medium text-gray-900 mb-4">
                                <i class="fa fa-list-alt mr-2 text-gray-600"></i>同步日志
                            </h3>
                            <div class="bg-gray-50 border border-gray-200 rounded-md p-4 max-h-60 overflow-y-auto">
                                <div id="syncLog" class="text-sm font-mono">
                                    <!-- 同步日志将在这里显示 -->
                                    <div class="text-gray-500">暂无同步记录</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="testConnectionBtn" 
                                class="inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all">
                            <i class="fa fa-wifi mr-2"></i>测试连接
                        </button>
                        
                        <button type="button" id="connectBtn" 
                                class="inline-flex justify-center items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all">
                            <i class="fa fa-connectdevelop mr-2"></i>连接服务器
                        </button>
                        
                        <button type="button" id="disconnectBtn" 
                                class="inline-flex justify-center items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all"
                                disabled>
                            <i class="fa fa-disconnect mr-2"></i>断开连接
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 同步统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-blue-100 rounded-md p-3">
                        <i class="fa fa-cloud-upload text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">已上传变更</dt>
                            <dd class="flex items-baseline">
                                <div class="text-2xl font-semibold text-gray-900" id="uploadedChanges">0</div>
                                <div class="ml-2 flex items-baseline text-sm font-semibold text-green-600">
                                    <i class="fa fa-arrow-up"></i>
                                </div>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-green-100 rounded-md p-3">
                        <i class="fa fa-cloud-download text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">已下载变更</dt>
                            <dd class="flex items-baseline">
                                <div class="text-2xl font-semibold text-gray-900" id="downloadedChanges">0</div>
                                <div class="ml-2 flex items-baseline text-sm font-semibold text-green-600">
                                    <i class="fa fa-arrow-up"></i>
                                </div>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-yellow-100 rounded-md p-3">
                        <i class="fa fa-clock-o text-yellow-600 text-xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">同步延迟</dt>
                            <dd class="flex items-baseline">
                                <div class="text-2xl font-semibold text-gray-900" id="syncLatency">-</div>
                                <div class="ml-2 flex items-baseline text-sm font-semibold text-gray-600">
                                    毫秒
                                </div>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="md:flex md:items-center md:justify-between">
                <div class="flex justify-center md:justify-start space-x-6">
                    <span class="text-gray-500 text-sm">© 2024 项目管理系统. 保留所有权利.</span>
                </div>
                <div class="mt-4 md:mt-0">
                    <p class="text-center md:text-right text-sm text-gray-500">
                        版本 1.0.0 | 网络同步版
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- 引入JavaScript文件 -->
    <script src="js/common.js"></script>
    <script src="js/multiuser.js"></script>
    <script src="js/network_sync.js"></script>
    <script src="js/sse_sync.js"></script>
    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeSyncConfig();
        });

        // 初始化同步配置页面
        function initializeSyncConfig() {
            // 加载配置
            loadSyncConfig();
            
            // 绑定事件
            bindConfigEvents();
            
            // 更新同步状态
            updateSyncStatus();
            
            // 加载同步日志
            loadSyncLog();
            
            // 初始化协议选择器
            initializeProtocolSelector();
        }

        // 初始化协议选择器
        function initializeProtocolSelector() {
            const protocolSelect = document.getElementById('syncProtocolSelect');
            const websocketUrlInput = document.getElementById('websocketUrl');
            const sseServerUrlInput = document.getElementById('sseServerUrl');
            
            // 加载保存的协议选择
            const savedProtocol = localStorage.getItem('sync_protocol') || 'websocket';
            protocolSelect.value = savedProtocol;
            
            // 根据选择的协议显示/隐藏相关配置
            updateProtocolVisibility(savedProtocol);
            
            // 绑定协议切换事件
            protocolSelect.addEventListener('change', function() {
                const selectedProtocol = this.value;
                localStorage.setItem('sync_protocol', selectedProtocol);
                updateProtocolVisibility(selectedProtocol);
                showToast(`已切换到${selectedProtocol === 'websocket' ? 'WebSocket' : 'SSE'}协议`, 'info');
            });
        }

        // 更新协议相关配置的可见性
        function updateProtocolVisibility(protocol) {
            const websocketUrlInput = document.getElementById('websocketUrl');
            const sseServerUrlInput = document.getElementById('sseServerUrl');
            
            if (protocol === 'websocket') {
                websocketUrlInput.parentElement.style.display = 'block';
                sseServerUrlInput.parentElement.style.display = 'none';
            } else {
                websocketUrlInput.parentElement.style.display = 'none';
                sseServerUrlInput.parentElement.style.display = 'block';
            }
        }

        // 加载同步配置
        function loadSyncConfig() {
            const config = getSyncConfig();
            
            // 填充表单
            document.getElementById('websocketUrl').value = config.websocketUrl || 'wss://echo.websocket.org';
            document.getElementById('syncInterval').value = config.syncInterval || 30;
            document.getElementById('enableRealtimeSync').checked = config.enableRealtimeSync !== false;
            document.getElementById('enableOfflineMode').checked = config.enableOfflineMode !== false;
            document.getElementById('autoSyncOnConnect').checked = config.autoSyncOnConnect !== false;
        }

        // 获取同步配置
        function getSyncConfig() {
            const config = localStorage.getItem('sync_config');
            return config ? JSON.parse(config) : {
                websocketUrl: 'wss://echo.websocket.org',
                syncInterval: 30,
                enableRealtimeSync: true,
                enableOfflineMode: true,
                autoSyncOnConnect: true
            };
        }

        // 保存同步配置
        function saveSyncConfig(config) {
            localStorage.setItem('sync_config', JSON.stringify(config));
            
            // 如果网络同步模块已加载，应用配置
            if (typeof networkSync !== 'undefined') {
                networkSync.serverUrl = config.websocketUrl;
            }
        }

        // 绑定配置事件
        function bindConfigEvents() {
            // 连接按钮
            document.getElementById('connectBtn').addEventListener('click', function() {
                connectToServer();
            });
            
            // 断开连接按钮
            document.getElementById('disconnectBtn').addEventListener('click', function() {
                disconnectFromServer();
            });
            
            // 测试连接按钮
            document.getElementById('testConnectionBtn').addEventListener('click', function() {
                testConnection();
            });
            
            // 导出数据按钮
            document.getElementById('exportDataBtn').addEventListener('click', function() {
                exportData();
            });
            
            // 导入数据按钮
            document.getElementById('importDataBtn').addEventListener('click', function() {
                document.getElementById('importFileInput').click();
            });
            
            // 导入文件选择
            document.getElementById('importFileInput').addEventListener('change', function(e) {
                importData(e.target.files[0]);
            });
            
            // 清除本地数据按钮
            document.getElementById('clearLocalDataBtn').addEventListener('click', function() {
                clearLocalData();
            });
            
            // 迁移数据按钮
            document.getElementById('migrateDataBtn').addEventListener('click', function() {
                migrateData();
            });
            
            // 表单提交
            document.getElementById('syncConfigForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveConfig();
            });
            
            // 自动保存配置
            const formElements = document.querySelectorAll('#syncConfigForm input, #syncConfigForm select');
            formElements.forEach(element => {
                element.addEventListener('change', function() {
                    saveConfig();
                });
            });
        }

        // 保存配置
        function saveConfig() {
            const config = {
                websocketUrl: document.getElementById('websocketUrl').value,
                syncInterval: parseInt(document.getElementById('syncInterval').value),
                enableRealtimeSync: document.getElementById('enableRealtimeSync').checked,
                enableOfflineMode: document.getElementById('enableOfflineMode').checked,
                autoSyncOnConnect: document.getElementById('autoSyncOnConnect').checked
            };
            
            saveSyncConfig(config);
            showToast('配置已保存', 'success');
        }

        // 连接到服务器
        async function connectToServer() {
            try {
                // 先保存配置
                saveConfig();
                
                const config = getSyncConfig();
                const session = getCurrentSession();
                
                if (!session) {
                    showToast('请先登录', 'error');
                    return;
                }
                
                // 显示加载状态
                const connectBtn = document.getElementById('connectBtn');
                const originalText = connectBtn.innerHTML;
                connectBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>连接中...';
                connectBtn.disabled = true;
                
                // 连接服务器
                if (typeof networkSync !== 'undefined') {
                    await networkSync.connect(session.user.id, session.token);
                    
                    // 更新按钮状态
                    connectBtn.disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    
                    showToast('成功连接到服务器', 'success');
                    updateSyncStatus();
                    
                    // 如果启用了自动同步
                    if (config.autoSyncOnConnect) {
                        setTimeout(() => {
                            networkSync.syncData();
                        }, 1000);
                    }
                } else {
                    showToast('网络同步模块未加载', 'error');
                }
                
            } catch (error) {
                console.error('连接失败:', error);
                showToast('连接失败: ' + error.message, 'error');
            } finally {
                // 恢复按钮状态
                const connectBtn = document.getElementById('connectBtn');
                connectBtn.innerHTML = '<i class="fa fa-connectdevelop mr-2"></i>连接服务器';
                connectBtn.disabled = false;
            }
        }

        // 断开连接
        function disconnectFromServer() {
            if (typeof networkSync !== 'undefined') {
                networkSync.disconnect();
                
                // 更新按钮状态
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                
                showToast('已断开服务器连接', 'info');
                updateSyncStatus();
            }
        }

        // 测试连接
        async function testConnection() {
            const websocketUrl = document.getElementById('websocketUrl').value;
            
            if (!websocketUrl) {
                showToast('请输入WebSocket服务器地址', 'warning');
                return;
            }
            
            try {
                const testBtn = document.getElementById('testConnectionBtn');
                const originalText = testBtn.innerHTML;
                testBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>测试中...';
                testBtn.disabled = true;
                
                // 创建临时WebSocket连接
                const socket = new WebSocket(websocketUrl);
                
                const startTime = Date.now();
                
                socket.onopen = () => {
                    const latency = Date.now() - startTime;
                    socket.close();
                    
                    testBtn.innerHTML = originalText;
                    testBtn.disabled = false;
                    
                    showToast(`连接成功！延迟: ${latency}ms`, 'success');
                    
                    // 更新延迟显示
                    document.getElementById('syncLatency').textContent = latency;
                };
                
                socket.onerror = (error) => {
                    testBtn.innerHTML = originalText;
                    testBtn.disabled = false;
                    showToast('连接失败: 无法连接到服务器', 'error');
                };
                
                socket.onclose = (event) => {
                    if (event.code !== 1000) { // 非正常关闭
                        testBtn.innerHTML = originalText;
                        testBtn.disabled = false;
                        showToast(`连接关闭: ${event.reason || '未知错误'}`, 'error');
                    }
                };
                
                // 5秒超时
                setTimeout(() => {
                    if (socket.readyState === WebSocket.CONNECTING) {
                        socket.close();
                        testBtn.innerHTML = originalText;
                        testBtn.disabled = false;
                        showToast('连接超时', 'error');
                    }
                }, 5000);
                
            } catch (error) {
                console.error('测试连接失败:', error);
                showToast('测试失败: ' + error.message, 'error');
                
                const testBtn = document.getElementById('testConnectionBtn');
                testBtn.innerHTML = '<i class="fa fa-wifi mr-2"></i>测试连接';
                testBtn.disabled = false;
            }
        }

        // 导出数据
        async function exportData() {
            try {
                if (typeof networkSync !== 'undefined' && networkSync.exportData) {
                    const data = await networkSync.exportData();
                    
                    // 创建下载链接
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `project_management_export_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast('数据导出成功', 'success');
                } else {
                    showToast('导出功能不可用', 'error');
                }
            } catch (error) {
                console.error('导出数据失败:', error);
                showToast('导出失败: ' + error.message, 'error');
            }
        }

        // 导入数据
        async function importData(file) {
            if (!file) return;
            
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (typeof networkSync !== 'undefined' && networkSync.importData) {
                            const success = await networkSync.importData(data);
                            
                            if (success) {
                                showToast('数据导入成功', 'success');
                                
                                // 重新加载页面以应用新数据
                                setTimeout(() => {
                                    location.reload();
                                }, 1000);
                            } else {
                                showToast('数据导入失败', 'error');
                            }
                        } else {
                            showToast('导入功能不可用', 'error');
                        }
                    } catch (parseError) {
                        showToast('文件格式错误', 'error');
                    }
                };
                
                reader.readAsText(file);
            } catch (error) {
                console.error('导入数据失败:', error);
                showToast('导入失败: ' + error.message, 'error');
            }
        }

        // 清除本地数据
        function clearLocalData() {
            if (confirm('确定要清除所有本地数据吗？此操作不可恢复！')) {
                try {
                    // 清除localStorage
                    localStorage.removeItem('projects');
                    localStorage.removeItem('companies');
                    localStorage.removeItem('sync_status');
                    localStorage.removeItem('data_migrated_to_indexeddb');
                    
                    // 清除IndexedDB（如果支持）
                    if (typeof indexedDB !== 'undefined') {
                        indexedDB.deleteDatabase('ProjectManagementSystem');
                    }
                    
                    showToast('本地数据已清除', 'success');
                    
                    // 重新加载页面
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('清除数据失败:', error);
                    showToast('清除失败: ' + error.message, 'error');
                }
            }
        }

        // 迁移数据
        async function migrateData() {
            if (typeof migrateLocalStorageToIndexedDB !== 'undefined') {
                try {
                    await migrateLocalStorageToIndexedDB();
                    showToast('数据迁移完成', 'success');
                    updateSyncStatus();
                } catch (error) {
                    console.error('迁移数据失败:', error);
                    showToast('迁移失败: ' + error.message, 'error');
                }
            } else {
                showToast('迁移功能不可用', 'error');
            }
        }

        // 更新同步状态
        function updateSyncStatus() {
            const connectionStatus = document.getElementById('connectionStatus');
            const lastSyncTime = document.getElementById('lastSyncTime');
            const pendingChanges = document.getElementById('pendingChanges');
            const storageMode = document.getElementById('storageMode');
            
            if (typeof networkSync !== 'undefined') {
                // 更新连接状态
                if (networkSync.isConnected) {
                    connectionStatus.textContent = '已连接';
                    connectionStatus.className = 'font-medium text-green-600';
                } else {
                    connectionStatus.textContent = '未连接';
                    connectionStatus.className = 'font-medium text-gray-600';
                }
                
                // 更新待同步变更
                pendingChanges.textContent = networkSync.pendingChanges ? networkSync.pendingChanges.length : 0;
                
                // 更新存储模式
                storageMode.textContent = 'IndexedDB + 网络同步';
                storageMode.className = 'font-medium text-blue-600';
            }
            
            // 更新上次同步时间
            const syncStatus = getSyncStatus();
            if (syncStatus.lastSyncTime > 0) {
                lastSyncTime.textContent = new Date(syncStatus.lastSyncTime).toLocaleString();
            }
        }

        // 获取同步状态
        function getSyncStatus() {
            const status = localStorage.getItem('sync_status');
            return status ? JSON.parse(status) : {
                lastSyncTime: 0,
                success: false,
                changesApplied: 0
            };
        }

        // 加载同步日志
        function loadSyncLog() {
            const logElement = document.getElementById('syncLog');
            const logs = getSyncLogs();
            
            if (logs.length === 0) {
                logElement.innerHTML = '<div class="text-gray-500">暂无同步记录</div>';
                return;
            }
            
            logElement.innerHTML = logs.map(log => {
                const time = new Date(log.timestamp).toLocaleTimeString();
                const colors = {
                    'info': 'text-blue-600',
                    'success': 'text-green-600',
                    'warning': 'text-yellow-600',
                    'error': 'text-red-600'
                };
                
                return `<div class="mb-1"><span class="text-gray-500">[${time}]</span> <span class="${colors[log.type] || 'text-gray-600'}">${log.message}</span></div>`;
            }).join('');
        }

        // 获取同步日志
        function getSyncLogs() {
            const logs = localStorage.getItem('sync_logs');
            return logs ? JSON.parse(logs) : [];
        }

        // 添加同步日志
        function addSyncLog(message, type = 'info') {
            const logs = getSyncLogs();
            logs.unshift({
                message: message,
                type: type,
                timestamp: Date.now()
            });
            
            // 只保留最近50条日志
            if (logs.length > 50) {
                logs.splice(50);
            }
            
            localStorage.setItem('sync_logs', JSON.stringify(logs));
            loadSyncLog();
        }

        // 定期更新状态
        setInterval(() => {
            updateSyncStatus();
        }, 5000);
    </script>
</body>
</html>